services:
  # Linux x86_64 build (runs in emulation on Apple Silicon)
  build-linux:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: docker/Dockerfile.linux
      platforms:
        - linux/amd64
      args:
        TAURI_SIGNING_PRIVATE_KEY: ${TAURI_SIGNING_PRIVATE_KEY:-}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${TAURI_SIGNING_PRIVATE_KEY_PASSWORD:-}
    volumes:
      - ../dist-docker/linux:/output
      - cargo-cache-linux:/root/.cargo/registry
      - target-cache-linux:/app/src-tauri/target
    environment:
      - CARGO_INCREMENTAL=1

  # Windows x86_64 build (cross-compilation from Linux)
  build-windows:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: docker/Dockerfile.windows
      platforms:
        - linux/amd64
      args:
        TAURI_SIGNING_PRIVATE_KEY: ${TAURI_SIGNING_PRIVATE_KEY:-}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${TAURI_SIGNING_PRIVATE_KEY_PASSWORD:-}
    volumes:
      - ../dist-docker/windows:/output
      - cargo-cache-windows:/root/.cargo/registry
      - target-cache-windows:/app/src-tauri/target
      - xwin-cache:/root/.xwin-cache
    environment:
      - CARGO_INCREMENTAL=1

volumes:
  cargo-cache-linux:
  cargo-cache-windows:
  target-cache-linux:
  target-cache-windows:
  xwin-cache:
